@page "/"
@using FoodHealthChecker.Components.Layout
@using FoodHealthChecker
@using Markdig
@using Microsoft.AspNetCore.Components
@using System.Runtime.CompilerServices
@implements IDisposable
<PageTitle> Food Health Checker</PageTitle>

<div class="container mt-2">
    <div style="display: flex; justify-content: space-between; ">
        <h3 class="card-title mb-2 fw-bold">AI Food Health Checker</h3>
        <a class="card-title mb-2 fw-bold btn btn-dark" href="@duplicateSpace" target="_blank">Duplicate this space</a>
    </div>

    <div class="row justify-content-center ">
        <div class="col-xl-12">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-0">@errorMessage</div>
            }
        </div>
        <div class="col-xl-4">
            <div class="card common-card-height">
                <div class="card-body">
                    <h4 class="card-title fw-bold required text-start">Image</h4>
                    <div class="form-group mb-3">
                        <!-- HTML -->
                        <label for="upload-image" class="custom-upload-button btn btn-primary @isUploadingImage">
                            Upload Image
                        </label>
                        <InputFile OnChange="HandleSelectedFiles" accept=".jpg,.png" class="btn btn-primary" id="upload-image" aria-describedby="fileHelp"></InputFile>
                    </div>
                    <div class="form-group mb-3">
                        <button class="btn btn-primary w-100" @onclick="CheckHealth" disabled="@(isProcessingResponse || isProcessingIngredients)">Check Health</button>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(ImageUrl))
                    {
                        <img src="@ImageUrl" alt="Preview Image" class="img-fluid rounded" style="max-height: 150px;" />
                    }
                </div>
            </div>
        </div>
        <div class="col-xl-8">
            <div class="card common-card-height">
                <div class="card-body">
                    <h4 class="card-title text-start ">Food Contents</h4>
                    @if (isProcessingIngredients)
                    {
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-lg-start ai-ingredients-response">
                            @((MarkupString)Markdig.Markdown.ToHtml(Ingredients, pipeline))
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mt-2">
        <div class="col-xl-12">
            <div class="card ">
                <div class="card-body">
                    <h4 class="card-title text-start">Final Verdict</h4>
                    @if (isProcessingResponse)
                    {
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-lg-start ai-response">
                            @((MarkupString)Markdown.ToHtml(Result, pipeline))
                        </p>
                    }
                </div>
            </div>
            <div class="alert alert-warning text-center fw-bold mb-0" role="alert">
                Warning: The content generated by AI can be inaccurate.
            </div>
        </div>
    </div>
</div>

@code {
    public string ImageUrl { get; set; } = string.Empty;
    public ReadOnlyMemory<byte> ImageData { get; set; }
    public string ImageName { get; set; } = string.Empty;

    public string Ingredients { get; set; } = string.Empty;
    public string Result { get; set; } = string.Empty;
    public string duplicateSpace  { get; set; } = string.Empty;

    [Inject]
    public MarkdownPipeline pipeline { get; set; } = default!;
    [Inject]
    public FoodCheckerService _foodCheckerService { get; set; } = default!;
    [Inject]
    private NavigationManager Navigation { get; set; } = default!;
    [Inject]
    private IConfiguration Config { get; set; } = default;

    protected override void OnInitialized()
    {
        duplicateSpace = Config.GetValue<string>("HFDuplicateSpace") ?? string.Empty;
        if (!_foodCheckerService.IsValid())
        {
            errorMessage = "API keys missing. Duplicate this space to add missing keys";
        }
    }

    private bool isProcessingIngredients = false;
    private bool isProcessingResponse = false;
    private string isUploadingImage = string.Empty;
    private string errorMessage = string.Empty;
    private CancellationTokenSource _cts = new CancellationTokenSource();


    private async Task HandleSelectedFiles(InputFileChangeEventArgs e)
    {
        isUploadingImage = "disabled";
        var imageFile = e.File;
        await InvokeAsync(() => this.StateHasChanged());
        if (imageFile != null)
        {
            // Ensure the TempImages folder exists
            var folderPath = Path.Combine("wwwroot", "temp");

            // Save the file to the server
            var filePath = Path.Combine(folderPath, imageFile.Name);
            using var stream = new FileStream(filePath, FileMode.Create);
            await imageFile.OpenReadStream().CopyToAsync(stream);

            // Read the file into a byte array
            ImageData = await ReadFileBytes(imageFile);
            ImageName = imageFile.Name;
            // Update the ImageUrl property with the complete URL
            var relativePath = Path.Combine("temp", imageFile.Name);
            ImageUrl = Navigation.ToAbsoluteUri(relativePath).ToString();
        }
        isUploadingImage = string.Empty;
        await InvokeAsync(() => this.StateHasChanged());

    }

    private async Task<ReadOnlyMemory<byte>> ReadFileBytes(IBrowserFile imageFile)
    {
        using var memoryStream = new MemoryStream();
        await imageFile.OpenReadStream().CopyToAsync(memoryStream);
        return memoryStream.ToArray();
    }

    private async Task CheckHealth()
    {
        isProcessingIngredients = true;
        isProcessingResponse = true;
        errorMessage = string.Empty;
        Result = string.Empty;
        Ingredients = string.Empty;
        if (!Uri.IsWellFormedUriString(ImageUrl, UriKind.Absolute))
        {
            errorMessage = "Invalid URL";
            isProcessingIngredients = false;
            await InvokeAsync(() => this.StateHasChanged());
            return;
        }
        try
        {
            await foreach (var response in _foodCheckerService.GetIngredirentsAsync(ImageUrl, _cts.Token))
            {
                isProcessingIngredients = false;
                Ingredients += response;
                await InvokeAsync(() => this.StateHasChanged());
            }
            if (Ingredients == "<|ERROR|>")
            {
                Ingredients = Ingredients.Replace("<|ERROR|>", "Not Found");
                errorMessage = "Failed to get ingredients";
            }
            else
            {
                if (Ingredients.Contains("<|ERROR|>"))
                {
                    Ingredients = Ingredients.Replace("<|ERROR|>", "Not Found");
                }
                await InvokeAsync(() => this.StateHasChanged());

                await foreach (var response in _foodCheckerService.CheckFoodHealthAsync(Ingredients, _cts.Token))
                {
                    isProcessingResponse = false;
                    Result += response;
                    await InvokeAsync(() => this.StateHasChanged());
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            errorMessage = $"Error: An unexpected error has occurred";
        }
        finally
        {
            isProcessingResponse = false;
            isProcessingIngredients = false;
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
    }

}
